<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV Font Lab — Probador de tamaño de letra</title>
  <style>
    :root{
      --bg: #0b0f19; /* dark navy */
      --fg: #e6e8ee;
      --muted: #9aa4b2;
      --accent: #7cc4ff;
      --card: #141b2d;
      --card-2: #101625;
      --border: #263043;
      --ok: #3ed598;
      --warn: #ffd166;
      --danger: #ff7b7b;

      /* Tipografía activa */
      --app-font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* Base aplicada dinámicamente */
      --root-size: 18px;
    }

    html { font-size: var(--root-size); }
    body {
      margin:0; color: var(--fg); background: radial-gradient(1200px 800px at 15% 0%, #121a2a 0%, #0b0f19 50%, #0b0f19 100%);
      font-family: var(--app-font);
      min-height: 100svh; display:grid; grid-template-columns: 380px 1fr; gap:24px; align-items: stretch;
    }

    aside.controls{
      background: linear-gradient(180deg, var(--card), var(--card-2));
      border-right:1px solid var(--border);
      padding:20px 18px; position: sticky; top:0; height:100svh; overflow:auto;
    }
    main.preview{ padding:20px; }

    h1,h2,h3,h4,h5,h6{ margin:0.6em 0 0.35em; line-height:1.15; }
    p{ line-height:1.6; color: var(--fg); }
    small{ color: var(--muted); }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid var(--border); border-radius:16px; padding:14px 16px; box-shadow: 0 6px 22px rgba(0,0,0,0.18); }
    .controls .card + .card{ margin-top:14px; }

    label{ font-size:0.9rem; color: var(--muted); display:block; margin-bottom:6px; }
    input[type="number"], input[type="range"], input[type="text"], select{
      width:100%; box-sizing:border-box; background:#0f1525; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:0.95rem;
    }
    input[type="range"]{ padding:0; height: 28px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }

    .title{ font-weight:600; letter-spacing:0.2px; margin-bottom:8px; color:#d8deea; }
    .muted{ color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:0.9rem; }

    .badge{ display:inline-flex; align-items:center; gap:8px; background:#0f1525; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:0.85rem; color:#cfe1ff; }
    .badges{ display:flex; flex-wrap:wrap; gap:8px; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }

    .sample{ padding:18px; border:1px dashed #2c3853; border-radius:14px; background: rgba(124,196,255,0.04); position:relative; overflow:hidden; }
    .sample h1{ font-size: 2.4rem; }
    .sample h2{ font-size: 2rem; }
    .sample h3{ font-size: 1.6rem; }
    .sample h4{ font-size: 1.3rem; }
    .sample p{ font-size: 1rem; }
    .sample .fine{ font-size: 0.85rem; color: var(--muted); }
    .sample .mega{ font-size: 3rem; font-weight:700; }
    .sample .ticker{ font-size: 3.5rem; font-weight:800; letter-spacing: 0.02em; }

    .kpi{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi .card{ text-align:center; }
    .kpi .label{ color: var(--muted); font-size:0.8rem; }
    .kpi .value{ font-size:1.2rem; font-weight:600; }

    .safe-overlay{ position: fixed; inset:0; pointer-events:none; display:none; }
    .safe-overlay.on{ display:block; }
    .safe-overlay .mask{ position:absolute; inset:5%; outline: 999vmax solid rgba(255, 209, 102, 0.18); border: 2px dashed var(--warn); }
    .safe-overlay .label{ position:absolute; top:6%; left:6%; background:rgba(0,0,0,0.45); color:var(--warn); padding:4px 8px; border-radius:8px; font-size:0.9rem; }

    .footer{ margin-top: 14px; color: var(--muted); font-size:0.85rem; }
    .btn{ background: linear-gradient(180deg, #1d2a45, #17223a); border:1px solid var(--border); color:#cfe1ff; border-radius:10px; padding:8px 10px; cursor:pointer; }
    .btn:active{ transform: translateY(1px); }
    .btn-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .calibox{ user-select:none; }
    .ruler{ height: 30px; background: repeating-linear-gradient(to right, #2c3853 0, #2c3853 1px, transparent 1px, transparent 10px); border:1px solid var(--border); border-radius:10px; position: relative; }
    .cal-rect{ height: 54px; background: rgba(62,213,152,0.15); border:2px solid var(--ok); border-radius:8px; margin:8px 0; position:relative; }
    .cal-rect:after{ content: attr(data-w) " px"; position:absolute; right:6px; top:4px; font-size:0.8rem; color:#9ee6c5; }

    .font-table{ width:100%; border-collapse: collapse; }
    .font-table th, .font-table td{ border-bottom:1px dashed #2c3853; padding:8px; text-align:left; }

    .virtual-vp{ position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0f1525; }
    .virtual-vp .bar{ position:absolute; inset:0 0 auto 0; height:34px; display:flex; align-items:center; gap:10px; padding:0 10px; background:rgba(0,0,0,0.3); border-bottom:1px solid var(--border); font-size:0.9rem; color:#cfe1ff; }
    .virtual-vp .content{ position:absolute; inset:34px 0 0 0; padding:16px; overflow:auto; }
  </style>
</head>
<body>
  <aside class="controls">
    <div class="title">TV Font Lab</div>
    <div class="muted" style="margin-bottom:12px">Detecta automáticamente la pantalla, calibra <strong>PPI real</strong> con un objeto físico y prueba <strong>tamaños en px</strong> con diferentes fuentes.</div>

    <div class="controls">
      <div class="card">
        <div class="title">1) Detección automática</div>
        <div class="row">
          <div>
            <label>screen.width × height (CSS px)</label>
            <input id="scrCss" type="text" readonly>
          </div>
          <div>
            <label>devicePixelRatio</label>
            <input id="scrDpr" type="text" readonly>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Resolución estimada (px reales)</label>
            <input id="scrReal" type="text" readonly>
          </div>
          <div>
            <label>Aplicar como panel</label>
            <button class="btn" id="applyScreen">Usar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="title">2) Parámetros del panel</div>
        <div class="row">
          <div>
            <label>Diagonal (pulgadas)</label>
            <input type="number" id="diag" value="55" step="0.1" min="10" />
          </div>
          <div>
            <label>Modo PPI</label>
            <select id="ppiMode">
              <option value="diag">Por diagonal (aprox.)</option>
              <option value="cal">Calibrado (preciso)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Ancho panel (px)</label>
            <input type="number" id="wpx" value="3840" step="1" min="640" />
          </div>
          <div>
            <label>Alto panel (px)</label>
            <input type="number" id="hpx" value="2160" step="1" min="360" />
          </div>
        </div>
        <small class="muted">Consejo: si lo abres en el TV, pulsa <em>Usar</em> arriba para cargar sus valores reales.</small>
      </div>

      <div class="card calibox">
        <div class="title">3) Calibración física (opcional pero recomendado)</div>
        <label>Objeto de referencia</label>
        <div class="row">
          <select id="refObj">
            <option value="85.6">Tarjeta CR80 (cédula/t. débito — 85.6 mm)</option>
            <option value="90">Tarjeta presentación (90 mm)</option>
            <option value="210">Hoja A4 (ancho — 210 mm)</option>
            <option value="148">Hoja A5 (ancho — 148 mm)</option>
            <option value="custom">Personalizado…</option>
          </select>
          <input type="number" id="refMm" value="85.6" step="0.1" min="10" />
        </div>
        <small class="muted">Ajusta el rectángulo hasta que coincida con el ancho físico del objeto sobre la pantalla.</small>
        <div class="ruler" aria-hidden="true"></div>
        <div class="cal-rect" id="calRect" data-w="200" style="width:200px"></div>
        <input type="range" id="calSlider" min="40" max="1200" value="200" />
        <div class="btn-row" style="margin-top:8px">
          <button class="btn" id="applyCal">Calcular PPI</button>
          <small class="muted">Resultado: <span id="ppiCal">—</span></small>
        </div>
      </div>

      <div class="card">
        <div class="title">4) Contexto de visualización</div>
        <div class="row">
          <div>
            <label>Distancia (metros)</label>
            <input type="number" id="distance" value="2.5" step="0.1" min="0.5" />
          </div>
          <div>
            <label>Legibilidad objetivo (arcmin)</label>
            <input type="number" id="arcmin" value="20" step="1" min="10" max="40" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>x‑height / font-size</label>
            <input type="number" id="xheight" value="0.5" step="0.01" min="0.4" max="0.7" />
          </div>
          <div>
            <label>Escala manual (× rem)</label>
            <input type="range" id="scale" min="0.6" max="1.6" value="1" step="0.01" />
          </div>
        </div>
        <div class="btn-row" style="margin-top:10px">
          <button class="btn" id="apply">Aplicar</button>
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
            <input type="checkbox" id="safe" /> <span>Área segura 5%</span>
          </label>
        </div>
      </div>

      <div class="card">
        <div class="title">5) Fuente y estilo</div>
        <label>Fuente del sistema / Google Fonts</label>
        <div class="row">
          <select id="fontPreset">
            <option value="system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial">System UI</option>
            <option value="Inter">Inter</option>
            <option value="Roboto">Roboto</option>
            <option value="Source Sans 3">Source Sans 3</option>
            <option value="Open Sans">Open Sans</option>
            <option value="Noto Sans">Noto Sans</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Poppins">Poppins</option>
            <option value="Lato">Lato</option>
            <option value="Nunito">Nunito</option>
            <option value="IBM Plex Sans">IBM Plex Sans</option>
            <option value="Oswald">Oswald (display)</option>
            <option value="Bebas Neue">Bebas Neue (display)</option>
            <option value="Roboto Mono">Roboto Mono</option>
            <option value="JetBrains Mono">JetBrains Mono</option>
          </select>
          <input type="text" id="fontCustom" placeholder="Otra de Google Fonts (exacta)" />
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button class="btn" id="loadFont">Cargar fuente</button>
          <label>Weight <input style="width:90px" type="number" id="fontWeight" value="400" min="100" max="900" step="50"></label>
          <label>Tracking <input style="width:90px" type="number" id="letterSpacing" value="0" step="0.01"></label>
        </div>
      </div>

      <div class="card">
        <div class="title">Resultados</div>
        <div class="kpi">
          <div class="card">
            <div class="label">PPI (modo activo)</div>
            <div class="value" id="ppi">—</div>
          </div>
          <div class="card">
            <div class="label">mm por píxel</div>
            <div class="value" id="mmpp">—</div>
          </div>
          <div class="card">
            <div class="label">x‑height objetivo</div>
            <div class="value" id="xmm">—</div>
          </div>
          <div class="card">
            <div class="label">font-size recomendado</div>
            <div class="value" id="fontpx">—</div>
          </div>
        </div>
        <div class="footer">
          <div class="title" style="margin-top:10px">CSS sugerido (base)</div>
          <pre class="mono" id="cssOut">:root{ font-size: 18px; }</pre>
        </div>
      </div>

      <div class="card">
        <div class="title">Guardar / Restaurar</div>
        <div class="btn-row">
          <button class="btn" id="saveCfg">Guardar configuración</button>
          <button class="btn" id="loadCfg">Cargar</button>
          <button class="btn" id="resetCfg">Reset</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="preview">
    <div class="badges">
      <div class="badge">Base <span id="baseRem">—</span> (px)</div>
      <div class="badge">Escala ×<span id="scaleOut">1.00</span></div>
      <div class="badge">Viewport: <span id="vp">—</span> CSS px</div>
      <div class="badge">Fuente: <span id="fontName">Inter</span></div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="sample">
        <h1>H1 — Título principal</h1>
        <p>Para dashboards en TV a 2–3 m, evita bloques de texto largos. Usa contraste alto y espacios amplios.</p>
        <p class="fine">Fine print — detalles secundarios y leyendas.</p>
      </div>
      <div class="sample">
        <h2>H2 — Sección</h2>
        <h3>H3 — Subtítulo</h3>
        <p>El tamaño base controla todas las escalas. Ajusta la <strong>escala manual</strong> para simular preferencias.</p>
      </div>
      <div class="sample">
        <div class="mega">123 456</div>
        <p>KPI grande — para métricas destacadas.</p>
      </div>
      <div class="sample">
        <div class="ticker">🟢 En servicio</div>
        <p>Texto tipo “marquesina”/estado con alto impacto visual.</p>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Prueba rápida por píxeles</div>
      <table class="font-table" id="pxTable">
        <thead>
          <tr><th>Tamaño (px)</th><th>Muestra</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Simulador de viewport</div>
      <small class="muted">Para comparar cómo se vería en 1080p vs 4K dentro de tu pantalla actual (escala visual aproximada).</small>
      <div class="row">
        <div>
          <label>Viewport objetivo (px)</label>
          <select id="vpPreset">
            <option value='{"w":1920,"h":1080}'>1080p — 1920×1080</option>
            <option value='{"w":2560,"h":1440}'>1440p — 2560×1440</option>
            <option value='{"w":3840,"h":2160}'>4K — 3840×2160</option>
            <option value='{"w":7680,"h":4320}'>8K — 7680×4320</option>
          </select>
        </div>
        <div>
          <label>Escala (% de la pantalla)</label>
          <input type="range" id="vpScale" min="20" max="100" value="60" />
        </div>
      </div>
      <div class="virtual-vp" id="virt" style="height:60vh">
        <div class="bar">Viewport simulado: <span id="virtLbl">1920×1080</span></div>
        <div class="content" id="virtContent">
          <h3>Vista simulada</h3>
          <p>Este recuadro escala proporcionalmente un viewport de referencia. Úsalo para visualizar densidad y jerarquía.</p>
          <p class="fine">Pangrama ES: <em>Benjamín pidió una bebida de kiwi y fresa; Noé, sexo y jazz.</em></p>
        </div>
      </div>
    </div>
  </main>

  <div class="safe-overlay" id="safeOverlay">
    <div class="mask"></div>
    <div class="label">Área segura 5%</div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>document.querySelectorAll(q);
    const $text = (el, v)=>{ el.textContent = v; };

    const el = {
      // auto detect
      scrCss: $('#scrCss'), scrDpr: $('#scrDpr'), scrReal: $('#scrReal'), applyScreen: $('#applyScreen'),
      // panel & ppi mode
      diag: $('#diag'), wpx: $('#wpx'), hpx: $('#hpx'), ppiMode: $('#ppiMode'),
      // calibration
      refObj: $('#refObj'), refMm: $('#refMm'), calRect: $('#calRect'), calSlider: $('#calSlider'), ppiCal: $('#ppiCal'), applyCal: $('#applyCal'),
      // viewing
      dist: $('#distance'), arcmin: $('#arcmin'), xheight: $('#xheight'), scale: $('#scale'),
      // font
      fontPreset: $('#fontPreset'), fontCustom: $('#fontCustom'), loadFont: $('#loadFont'), fontWeight: $('#fontWeight'), letterSpacing: $('#letterSpacing'), fontName: $('#fontName'),
      // results
      ppi: $('#ppi'), mmpp: $('#mmpp'), xmm: $('#xmm'), fontpx: $('#fontpx'), cssOut: $('#cssOut'), baseRem: $('#baseRem'), scaleOut: $('#scaleOut'), vp: $('#vp'), apply: $('#apply'),
      // safe area
      safe: $('#safe'), safeOverlay: $('#safeOverlay'),
      // px table
      pxTable: $('#pxTable').querySelector('tbody'),
      // virtual viewport
      vpPreset: $('#vpPreset'), vpScale: $('#vpScale'), virt: $('#virt'), virtLbl: $('#virtLbl'), virtContent: $('#virtContent'),
      // cfg
      saveCfg: $('#saveCfg'), loadCfg: $('#loadCfg'), resetCfg: $('#resetCfg')
    };

    // ===== Utils
    const clamp = (v,a,b)=>Math.max(a, Math.min(v,b));
    function computePPI(w, h, diag){
      const pxDiag = Math.sqrt(w*w + h*h);
      return pxDiag / diag; // px por pulgada
    }
    function arcminToRadians(arcmin){ return (arcmin/60) * Math.PI/180; }
    function recommendedFontPx({distance_m, arcmin, xheight_ratio, ppi}){
      const theta = arcminToRadians(arcmin);
      const height_mm = Math.tan(theta) * (distance_m * 1000);
      const mm_per_px = 25.4 / ppi;
      const x_px = height_mm / mm_per_px;
      const font_px = x_px / xheight_ratio;
      return { font_px, x_px, mm_per_px };
    }

    // ===== Auto detect screen
    function detectScreen(){
      const cssW = (window.screen && window.screen.width) ? window.screen.width : window.innerWidth;
      const cssH = (window.screen && window.screen.height) ? window.screen.height : window.innerHeight;
      const dpr = window.devicePixelRatio || 1;
      const realW = Math.round(cssW * dpr);
      const realH = Math.round(cssH * dpr);
      el.scrCss.value = cssW + '×' + cssH;
      el.scrDpr.value = dpr.toFixed(2);
      el.scrReal.value = realW + '×' + realH;
      return { cssW, cssH, dpr, realW, realH };
    }

    // ===== Calibration
    function updateCalWidth(px){
      el.calRect.style.width = px + 'px';
      el.calRect.setAttribute('data-w', px);
      el.calSlider.value = px;
    }
    function calcCalibratedPPI(){
      const px = parseFloat(el.calSlider.value);
      const mm = parseFloat(el.refMm.value);
      if(!px || !mm) return null;
      const mm_per_px = mm / px;
      const ppi = 25.4 / mm_per_px;
      return { ppi, mm_per_px };
    }

    // ===== Apply
    let ppi_calibrated = null;
    function getActivePPI(){
      const w = parseInt(el.wpx.value,10); const h = parseInt(el.hpx.value,10); const diag = parseFloat(el.diag.value);
      const byDiag = computePPI(w,h,diag);
      if(el.ppiMode.value === 'cal' && ppi_calibrated){ return ppi_calibrated; }
      return byDiag;
    }

    function applyNow(){
      const w = parseInt(el.wpx.value || '3840', 10);
      const h = parseInt(el.hpx.value || '2160', 10);
      const distance = parseFloat(el.dist.value || '2.5');
      const arcmin = parseFloat(el.arcmin.value || '20');
      const xratio = parseFloat(el.xheight.value || '0.5');
      const scale = parseFloat(el.scale.value || '1');

      const ppi = getActivePPI();
      const { font_px, x_px, mm_per_px } = recommendedFontPx({ distance_m: distance, arcmin, xheight_ratio: xratio, ppi });
      const applied = Math.max(10, Math.round(font_px * scale));
      document.documentElement.style.setProperty('--root-size', applied + 'px');

      $text(el.ppi, ppi.toFixed(1) + ' ppi');
      $text(el.mmpp, mm_per_px.toFixed(3) + ' mm/px');
      $text(el.xmm, x_px.toFixed(1) + ' px (x-height)');
      $text(el.fontpx, applied + ' px');
      $text(el.baseRem, getComputedStyle(document.documentElement).fontSize);
      $text(el.scaleOut, scale.toFixed(2));
      $text(el.vp, window.innerWidth + '×' + window.innerHeight);

      const css = `:root{\n  /* Calculado para ${el.diag.value}\" @ ${w}×${h} — modo ${el.ppiMode.value} */\n  font-size: ${applied}px;\n}\n\n/* Alternativa elástica entre 1080p y 4K */\n:root{\n  font-size: clamp(14px, 1.6vh + 0.2vw, 24px);\n}`;
      el.cssOut.textContent = css;

      renderPxTable();
      updateVirtualViewport();
      saveAuto();
    }

    // ===== Font handling
    function setFontFamily(family){
      document.documentElement.style.setProperty('--app-font', family + ', system-ui, -apple-system, Segoe UI, Roboto, Arial');
      $text(el.fontName, family);
      document.documentElement.style.letterSpacing = (parseFloat(el.letterSpacing.value)||0) + 'px';
      document.documentElement.style.fontWeight = clamp(parseInt(el.fontWeight.value||'400',10),100,900);
    }
    function loadGoogleFont(family){
      if(!family) return;
      const id = 'gf-'+family.replace(/\s+/g,'-');
      if(!document.getElementById(id)){
        const link = document.createElement('link');
        link.id = id;
        link.rel = 'stylesheet';
        link.href = 'https://fonts.googleapis.com/css2?family='+encodeURIComponent(family)+':wght@100;200;300;400;500;600;700;800;900&display=swap';
        document.head.appendChild(link);
      }
      setFontFamily(family);
    }

    // ===== PX table
    function renderPxTable(){
      const sizes = [12,14,16,18,20,22,24,28,32,36,40,44,48,56,64,72,96,120];
      el.pxTable.innerHTML = '';
      for(const s of sizes){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = s + ' px'; td1.className='mono';
        const td2 = document.createElement('td');
        const p = document.createElement('p'); p.style.margin='6px 0'; p.style.fontSize = s+'px'; p.innerHTML = 'Tamaño '+s+'px — <em>Benjamín pidió una bebida de kiwi y fresa; Noé, sexo y jazz.</em>';
        td2.appendChild(p);
        tr.appendChild(td1); tr.appendChild(td2);
        el.pxTable.appendChild(tr);
      }
    }

    // ===== Virtual viewport simulator
    function updateVirtualViewport(){
      try{
        const obj = JSON.parse(el.vpPreset.value);
        const scale = (parseInt(el.vpScale.value,10)||60)/100;
        const aspect = obj.w/obj.h;
        const cont = el.virt;
        // Fit width to container width * scale, maintain aspect via height ratio
        const contW = el.virt.clientWidth;
        const targetW = Math.max(280, contW * scale);
        const targetH = targetW / aspect;
        el.virt.style.height = Math.round(targetH + 34) + 'px'; // include bar height
        $text(el.virtLbl, obj.w + '×' + obj.h);
        el.virt.style.setProperty('--virt-w', obj.w + 'px');
      }catch(e){}
    }

    // ===== Local storage
    const KEY = 'tv-font-lab@v2';
    function saveAuto(){
      const data = {
        diag: el.diag.value, w: el.wpx.value, h: el.hpx.value, ppiMode: el.ppiMode.value,
        refMm: el.refMm.value, calPx: el.calSlider.value, ppiCal: ppi_calibrated,
        distance: el.dist.value, arcmin: el.arcmin.value, xheight: el.xheight.value, scale: el.scale.value,
        fontFamily: el.fontName.textContent, fontWeight: el.fontWeight.value, letterSpacing: el.letterSpacing.value,
        vpPreset: el.vpPreset.value, vpScale: el.vpScale.value
      };
      try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){}
    }
    function loadSaved(){
      try{
        const raw = localStorage.getItem(KEY); if(!raw) return;
        const d = JSON.parse(raw);
        el.diag.value = d.diag || el.diag.value;
        el.wpx.value = d.w || el.wpx.value; el.hpx.value = d.h || el.hpx.value;
        el.ppiMode.value = d.ppiMode || 'diag';
        el.refMm.value = d.refMm || el.refMm.value; updateCalWidth(parseInt(d.calPx||'200',10));
        ppi_calibrated = d.ppiCal || null; $text(el.ppiCal, ppi_calibrated ? ppi_calibrated.toFixed(1)+' ppi' : '—');
        el.dist.value = d.distance || el.dist.value; el.arcmin.value = d.arcmin || el.arcmin.value; el.xheight.value = d.xheight || el.xheight.value; el.scale.value = d.scale || el.scale.value;
        el.fontWeight.value = d.fontWeight || el.fontWeight.value; el.letterSpacing.value = d.letterSpacing || el.letterSpacing.value;
        if(d.fontFamily){ setFontFamily(d.fontFamily); }
        el.vpPreset.value = d.vpPreset || el.vpPreset.value; el.vpScale.value = d.vpScale || el.vpScale.value;
      }catch(e){}
    }

    // ===== Events
    el.apply.addEventListener('click', applyNow);
    el.scale.addEventListener('input', applyNow);
    el.safe.addEventListener('change', ()=>{ el.safeOverlay.classList.toggle('on', el.safe.checked); });

    el.applyScreen.addEventListener('click', ()=>{
      const d = detectScreen();
      el.wpx.value = d.realW; el.hpx.value = d.realH; applyNow();
    });

    el.refObj.addEventListener('change', ()=>{
      const v = el.refObj.value;
      if(v === 'custom') return; else el.refMm.value = v;
    });
    el.calSlider.addEventListener('input', ()=>{ updateCalWidth(parseInt(el.calSlider.value,10)); });
    el.applyCal.addEventListener('click', ()=>{
      const r = calcCalibratedPPI();
      if(r){ ppi_calibrated = r.ppi; $text(el.ppiCal, r.ppi.toFixed(1) + ' ppi'); applyNow(); }
    });

    el.fontPreset.addEventListener('change', ()=>{ const f = el.fontPreset.value; loadGoogleFont(f); saveAuto(); });
    el.loadFont.addEventListener('click', ()=>{ const f = (el.fontCustom.value || '').trim(); if(f) loadGoogleFont(f); saveAuto(); });
    el.fontWeight.addEventListener('input', ()=>{ setFontFamily(el.fontName.textContent); saveAuto(); });
    el.letterSpacing.addEventListener('input', ()=>{ setFontFamily(el.fontName.textContent); saveAuto(); });

    el.vpPreset.addEventListener('change', updateVirtualViewport);
    el.vpScale.addEventListener('input', updateVirtualViewport);

    el.saveCfg.addEventListener('click', ()=>{ saveAuto(); alert('Configuración guardada en este navegador.'); });
    el.loadCfg.addEventListener('click', ()=>{ loadSaved(); applyNow(); });
    el.resetCfg.addEventListener('click', ()=>{ localStorage.removeItem(KEY); location.reload(); });

    window.addEventListener('resize', ()=>{ $text(el.vp, window.innerWidth + '×' + window.innerHeight); updateVirtualViewport(); });

    // ===== Init
    (function init(){
      // preload Inter via Google Fonts (mejor legibilidad)
      loadGoogleFont('Inter');
      detectScreen();
      updateCalWidth(200);
      renderPxTable();
      loadSaved();
      applyNow();
      updateVirtualViewport();
    })();
  </script>
</body>
</html>
